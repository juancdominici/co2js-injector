# CO2.js Injector Action

A GitHub Action that measures the estimated CO2 emissions associated with the transfer of your code (based on file size) using [CO2.js](https://github.com/thegreenwebfoundation/co2.js).

This action calculates the total size of your files and estimates the carbon emissions that would be generated by transferring that amount of data. It outputs the estimated emissions and generates a `report.txt` file containing the metrics.

## Usage

### Using in your own repository

Add this action to your workflow file (e.g., `.github/workflows/measure-co2.yml`):

```yaml
name: Measure CO2 Emissions

on: [push]

jobs:
  measure:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Measure CO2 Emissions
        id: measure_co2
        uses: juancdominici/co2js-injector@v1.0.0
        with:
          path: './dist' # Optional: Path to measure (default: '.')
          green-hosting: 'true' # Optional: Is the hosting green? (default: 'false')
          destination: './public' # Optional: Where to write report.txt (default: '.')
          cloudflare-enabled: 'true' # Optional: Enable Cloudflare analytics
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }} # Optional
          cloudflare-zone-id: 'your-zone-id' # Optional
          cloudflare-since: '2025-11-01' # Optional: Start date (YYYY-MM-DD)
          cloudflare-until: '2025-11-30' # Optional: End date (YYYY-MM-DD)
      
      - name: Print Emissions
        run: echo |
            "Estimated CO2: ${{ steps.measure_co2.outputs.emissions }} grams"
```

## Inputs

| Input | Description | Required | Default |
| :--- | :--- | :--- | :--- |
| `path` | Path to the directory or file to measure. | No | `.` |
| `green-hosting` | Set to `'true'` if your hosting provider uses green energy. | No | `'false'` |
| `destination` | Directory where the `report.txt` file will be written. | No | `.` |
| `cloudflare-enabled` | Set to `'true'` to fetch Cloudflare analytics and traffic data. | No | `'false'` |
| `cloudflare-api-token` | Cloudflare API token with permissions to read analytics for the specified zone. | No | - |
| `cloudflare-zone-id` | Cloudflare Zone ID to query analytics for. | No | - |
| `cloudflare-since` | Start date for the Cloudflare analytics window in `YYYY-MM-DD` format. Defaults to 30 days ago if not set. | No | - |
| `cloudflare-until` | End date for the Cloudflare analytics window in `YYYY-MM-DD` format. Defaults to today if not set. | No | - |

## Outputs

| Output | Description |
| :--- | :--- |
| `emissions` | The estimated CO2 emissions in grams. |

## How it Works

1. **Calculates Size**: Scans the specified `path` (ignoring `node_modules` and `.git`) to calculate the total size of files in bytes.
2. **Estimates Emissions**: Uses the CO2.js `1byte` model to estimate carbon emissions based on the data transfer size and whether the hosting is green.
3. **Generates Report**: Creates a `report.txt` file in the `destination` directory with the following format (the `cloudflare` section is included only when Cloudflare integration is enabled and succeeds):
   ```toml
   # Generated by CO2.js GitHub Action
   version = "0.3"
   last_updated = "2023-10-27T10:00:00.000Z"

   [build]
   date = "2023-10-27T10:00:00.000Z"
   total_bytes = 12345
   green_hosting = true
   estimated_co2_grams = 0.123

   [cloudflare]
   zone_id = "your-zone-id"
   since = "2023-10-20"
   until = "2023-10-27"
   requests = 123456
   bytes = 78901234

   [[cloudflare.daily]]
   date = "2023-10-27"
   requests = 12345
   bytes = 6789012
   ```

## License

ISC
